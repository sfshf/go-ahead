
[Test packages](https://golang.google.cn/cmd/go/#hdr-Test_packages)

##### 一、`go test`命令的用法

```

go test [build/test flags] [packages] [build/test flags & test binary flags]

```

##### 二、`go test`命令的说明

`go test`自动测试由导入路径指名的包。它用以下格式打印测试结果摘要:

```

ok   archive/tar   0.011s
FAIL archive/zip   0.022s
ok   compress/gzip 0.033s
...

```

后面跟着每个失败包的细节输出。

`go test`将对每个包以及名字与文件模式`*_test.go`匹配的任何文件进行重新编译。这些附加文件可以包含测试（test）函数、基准测试（benchmark）函数和示例（example）函数。更多信息请参见`go help testfunc`。每个列出的包都会执行一个单独的测试二进制文件。名字以`_`(包括`_test.go`)或`.`开头的文件都会被忽略。

声明了一个带有`_test`后缀的包的测试文件，将会被编译为独立的包，然后与主测试二进制文件链接并运行。

`go`命令工具将忽略名为`testdata`的目录，使其可用来保存测试所需的辅助数据。

作为构建测试二进制文件的一部分，`go test`命令会运行`go vet`命令对包及其测试源文件进行检查，以识别重要的问题。如果`go vet`发现任何问题，`go test`报告这些问题，并且不运行测试二进制。只属于默认`go vet`检查的高可信子集才会被使用。这个子集有:`atomic`、`bool`、`buildtags`、`nilfunc`和`printf`。你可以通过`go doc cmd/vet`查看这些和其他检查（vet）测试的文档。要禁用`go vet`的运行，可以使用`-vet=off`标志。

所有的测试输出和汇总行都被打印到`go`命令的标准输出中，即使`test`命令将它们打印到自己的标准错误中。(`go`命令的标准错误是为打印生成测试的错误而保留的。)

`go test`可以以两种不同的模式运行：

第一种模式，称为本地目录模式（local directory mode），在调用`go test`时不使用包参数(例如，`go test`或`go test -v`)。在这种模式下，`go test`编译当前目录中找到的包内源码和测试，然后运行生成的测试二进制文件。在此模式下，将禁用缓存(将在下面讨论)。包测试完成后，`go test`打印一个摘要行，显示测试状态(`ok`或`FAIL`)、包名和运行时间。

第二种模式，称为包列表模式（package list mode），当`go test`使用显式的包参数(例如`go test math`、`go test ./...`，甚至`go test .`)。在这种模式下，`go test`编译并测试命令行中列出的每个包。如果包测试通过，`go test`只打印最后的`ok`汇总行。如果包测试失败，则`go test`打印完整的测试输出。如果使用`-bench`或`-v`标志调用，则`go test`在通过包测试时也会打印完整的输出，以显示被请求的基准测试结果或详细的日志记录。在所有列出的包测试完成并打印它们的输出之后，如果任何包测试失败，`go test`将打印最终的`FAIL`状态。

仅在包列表模式（package list mode）下，`go test`会缓存成功的包测试结果，以避免不必要的重复运行测试。当测试的结果可以从缓存中恢复时，`go test`将重新显示以前的输出，而不是再次运行测试二进制。当发生这种情况时，在摘要行中`go test`会打印`(cached)`来代替运行时间。

缓存中的匹配规则是，运行涉及的是相同的测试二进制文件，并且命令行上的标志完全来自一组受限的`cacheable`测试标志，它们是`-cpu`、`-list`、`-parallel`、`-run`、`-short`和`-v`。如果`go test`运行使用了在这个集合之外有任何测试或非测试标志，则不会缓存结果。要禁用测试缓存，使用可缓存标志之外的任何测试标志或参数即可。显式禁用测试缓存的惯用方法是使用`-count=1`标志。在包的源根目录下打开文件(通常是`$GOPATH`)或者查询环境变量的测试只会匹配文件和环境变量没有改变的未来运行。缓存的测试结果是完全被视为立即执行的，因此成功的包测试结果将被缓存并重用，而不顾`-timeout`设置。

除了构建标志之外，`go test`本身处理的标志有:

| 标志名 | 简单说明 |
|--|--|
| -args | 将命令行的其余部分(`-args`之后的所有内容)不进行解释和改变，直接传递给测试二进制文件。由于此标志将使用命令行的其余部分，因此包列表(如果存在)必须出现在此标志之前。 |
| -c | 将测试二进制编译为`pkg.test`，但不要运行它(其中`pkg`是包导入路径的最后一个元素)。可以使用`-o`标志更改文件名。 |
| -exec xprog | 使用`xprog`运行测试二进制文件。其行为与`go run`相同。详情请见`go help run`。 |
| -i | 安装作为测试依赖项的包。不运行测试。 |
| -json | 将测试输出转换为适合自动处理的JSON。有关编码细节，请参见`go doc test2json`。 |
| -o file | 将测试二进制文件编译为指名的文件。测试仍会进行（除非指明了`-c`或`-i`标志）。 |

测试二进制也接收控制测试执行的标志;这些标志也可以通过`go test`访问。详情请参阅`go help testflag`。

使用`go help build`查看更多关于构建标志的信息。

使用`go help packages`查看更多关于包的详细说明。

更多查看：[`go build`](build.md)、[`go vet`](vet.md)。
