
# Cookie与Session的简介

Web开发中一个很重要的议题就是`如何做好用户的整个浏览的控制`，因为`HTTP协议是无状态的`，所以`用户的每一次请求都是无状态的`，我们不知道在整个Web操作过程中哪些连接与该用户有关，应该如何来解决这个问题？

Web里面经典的解决方案是`Cookie`和`Session`。

`Cookie`机制是一个`客户端机制`，把用户数据保存在客户端，而`Session`机制是一种`服务器端的机制`，服务器`使用一种类似于散列表的结构来保存信息`，每一个网站访客都会被分配一个`唯一的标识符`，即`SessionID`。

`SessionID`的存放形式无非两种，要么`经过url传递`，要么`保存在客户端的Cookie里`。


## `Session`和`Cookie`是怎么来的？

因为要考虑用户如何访问受限网页的问题。

用户登录成功后，服务器如何验证该用户对之后受限制页面的访问？

因为`HTTP协议是无状态的`，所以很显然服务器`不可能知道`用户已经在`上一次`的HTTP请求中`通过了验证`。当然，最简单的解决方案就是所有的请求里面都带上用户名和密码，这样虽然可行，但大大加重了服务器的负担（对于每个request都需要到数据库验证），也大大降低了用户的体验（每个页面都需要重新输入用户名和密码，每个页面都带有登录表单）。既然直接在请求中带上用户名和密码不可行，那么就只有在服务器或客户端保存一些类似的可以代表身份的信息，所以就有了`Cookie`与`Session`。

`Cookie`简而言之就是，在本地计算机保存一些用户操作的历史信息（当然包括登录信息），并在用户再次访问该站点时浏览器通过HTTP协议将本地Cookie内容发送给服务器，从而完成验证，或继续上一次操作。

`Session`简而言之就是，在服务器上保存用户操作的历史信息。服务器使用`SessionID`来标识`Session`，`SessionID`由服务器负责产生，保证随机性与唯一性，相当于一个随机密钥，避免在握手或者传输中暴露用户真实密码。但该方式下，仍然需要将发送请求的客户端与`Session`进行对应，所以可以借助`Cookie`机制来获取客户端的标识（即`SessionID`），也可以通过GET方式将ID提交给服务器。


## `Cookie`

`Cookie`是由浏览器维持的，存储在客户端的一小段文本信息，伴随着用户请求和页面在Web服务器和浏览器之间传递。用户每次访问站点时，Web应用程序都可以读取Cookie包含的信息。浏览器设置里面有Cookie隐私数据选项，打开它，可以看到很多已访问网站的Cookies。

`Cookie`是有时间限制的，根据生命期不同分成两种：`会话Cookie`和`持久Cookie`：

`会话Cookie` -- 如果`不设置过期时间`，则表示这个Cookie生命周期为从创建到浏览器关闭为止，只要关闭浏览器窗口，Cookie就消失。这种`生命期为浏览会话期的Cookie`被称为`会话Cookie`。`会话Cookie`一般不保存在硬盘上而是保存在内存里。

`持久Cookie` -- 如果`设置了过期时间`，`浏览器就会把Cookie保存到硬盘上`，关闭后再次打开浏览器，这些Cookie依然有效直到超过设定的过期时间。存储在硬盘上的Cookie可以在不同的浏览器进程间共享，比如两个IE窗口。而对于保存在内存的Cookie，不同的浏览器有不同的处理方式。


## `Session`

`Session`，中文通常翻译为`会话`，该词与网络协议相关联时，它往往隐含了`面向连接`和/或`保持状态`这样两个含义。

`Session`在Web开发环境下的语义又有了新的扩展，它的含义是指一类用来在客户端与服务器之间保持状态的解决方案。有时候`Session`也用来指这种解决方案的存储结构。

`Session`机制是一种服务器端的机制，服务器使用一种类似于散列表的结构（也可能就是使用散列表）来保存信息。


## `Session`创建过程

- 1、 生成全局唯一的标识符（SessionID）。

- 2、 开辟数据存储空间。服务端程序一般会在内存中创建相应的数据结构，但这种情况下，系统一旦断电，所有的会话数据就会丢失，如果是电子商务类网站，这将造成严重的后果。所以为了解决这类问题，您`可以将会话数据写到文件里或存储在数据库`中，当然这样会增加I/O开销，但是它`可以实现某种程度的Session持久化`，也`更有利于Session的共享`。

- 3、 将`Session`的全局唯一标识符发送给客户端。

以上`三个步骤`中，最关键的是如何发送这个Session的唯一标识符这一步。考虑到HTTP协议的定义，数据无非可以放到`请求行`、`头域`或`Body`里，所以一般来说会有`两种常见的发送方式`：`Cookie`和`URL重写`。

- `Cookie`：服务端通过设置`Set-Cookie`头就可以将`Session标识符`传送到客户端，而客户端此后的每一次请求都会带上这个标识符，另外一般包含`Session`信息的`Cookie`会将`失效时间`设置为`0`（`会话Cookie`），即浏览器进程有效时间。至于浏览器怎么处理这个`0`，每个浏览器都有自己的方案，但差别不会太大（一般体现在新建浏览器窗口的时候）。

- `URL重写`：所谓`URL重写`，就是在返回给用户的页面里的所有的URL后面追加`Session标识符`，这样用户在收到响应之后，无论点击响应页面里的哪个连接或提交表单，都会自动带上`Session标识符`，从而就实现了会话的保持。虽然这种做法比较麻烦，但是，`如果客户端禁用了Cookie的话`，此种方案将会是首选。


## Session劫持防范

**cookieonly和token**

**间隔生成新的SID**
